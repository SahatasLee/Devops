input {
  elasticsearch {
    hosts => ["http://elasticsearch_host:9200"]  # Replace with your Elasticsearch host and port
    index => ".ds-heartbeat-*"                  # Replace with the correct index pattern
    query => '{"query": {"match": {"monitor.status": "down"}}}'  # Query for "down" status
    scroll => "5m"
    docinfo => true
  }
}

filter {
  aggregate {
    task_id => "%{[fields][monitor.id]}"
    code => "
      map['down_count'] ||= 0
      map['first_timestamp'] ||= event.get('@timestamp')
      map['last_timestamp'] = event.get('@timestamp')
      map['down_count'] += 1
    "
    timeout_task_id_field => "[fields][monitor.id]"
    timeout => 900  # 15 minutes in seconds
    push_map_as_event_on_timeout => true
  }

  if [type] == "logstash-aggregate" {
    if [down_count] >= 5 {
      mutate {
        add_field => { "alert" => "Down status occurred more than 5 times in 15 minutes" }
      }
    }
  }
}

output {
  if [alert] {
    stdout {
      codec => rubydebug
    }
    # You can add your desired alerting mechanism here, e.g., email, Slack, etc.
  }
}
